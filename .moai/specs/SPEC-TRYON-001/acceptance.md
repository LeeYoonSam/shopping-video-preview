---
id: SPEC-TRYON-001
type: acceptance
version: "1.0.0"
created: "2025-12-23"
updated: "2025-12-23"
traceability:
  spec: "./spec.md"
  plan: "./plan.md"
---

# SPEC-TRYON-001: 인수 조건 (Acceptance Criteria)

## 개요

이 문서는 AI 가상 착용 이미지 생성 시스템의 인수 조건과 테스트 시나리오를 정의합니다.

---

## 핵심 시나리오 (Given/When/Then)

### 시나리오 1: 상품 이미지 업로드

**Given (전제 조건)**
- 사용자가 인증된 상태이다
- 유효한 상품 ID가 존재한다
- 업로드할 이미지 파일이 JPEG 형식이고 5MB 이하이다

**When (실행)**
- 사용자가 POST /api/tryon/upload 엔드포인트에 상품 이미지를 업로드한다

**Then (결과)**
- 시스템은 HTTP 201 Created 응답을 반환한다
- 응답에 생성된 이미지의 ID, originalUrl, processedUrl이 포함된다
- 이미지가 S3/R2 스토리지에 저장된다
- ProductImage 테이블에 메타데이터가 기록된다
- 이미지가 지정된 최대 해상도로 리사이징된다

---

### 시나리오 2: 가상 착용 이미지 생성 요청

**Given (전제 조건)**
- 유효한 상품 이미지 ID가 존재한다
- 유효한 모델 이미지 ID가 존재한다
- 동일한 조합의 캐시된 결과가 없다

**When (실행)**
- 사용자가 POST /api/tryon/generate 엔드포인트에 생성 요청을 보낸다

**Then (결과)**
- 시스템은 HTTP 202 Accepted 응답을 반환한다
- 응답에 jobId와 status: "queued"가 포함된다
- TryOnJob 테이블에 새 작업이 생성된다
- Bull Queue에 작업이 등록된다
- 예상 대기 시간이 응답에 포함된다

---

### 시나리오 3: 캐시된 결과 반환

**Given (전제 조건)**
- 유효한 상품 이미지 ID가 존재한다
- 유효한 모델 이미지 ID가 존재한다
- 동일한 조합의 캐시된 결과가 존재한다
- 캐시가 만료되지 않았다

**When (실행)**
- 사용자가 POST /api/tryon/generate 엔드포인트에 생성 요청을 보낸다

**Then (결과)**
- 시스템은 HTTP 200 OK 응답을 반환한다
- 응답에 cached: true와 resultImageUrl이 포함된다
- 새로운 FASHN AI API 호출이 발생하지 않는다
- 캐시 히트 메트릭이 증가한다

---

### 시나리오 4: 작업 진행 상태 조회

**Given (전제 조건)**
- 유효한 jobId가 존재한다
- 해당 작업이 "processing" 상태이다

**When (실행)**
- 사용자가 GET /api/tryon/jobs/:jobId 엔드포인트를 호출한다

**Then (결과)**
- 시스템은 HTTP 200 OK 응답을 반환한다
- 응답에 status: "processing"과 progress (0-100)가 포함된다
- 진행률이 실시간으로 업데이트된 값을 반영한다

---

### 시나리오 5: 작업 완료 및 결과 조회

**Given (전제 조건)**
- 유효한 jobId가 존재한다
- 해당 작업이 "completed" 상태이다
- 결과 이미지가 스토리지에 저장되어 있다

**When (실행)**
- 사용자가 GET /api/tryon/jobs/:jobId 엔드포인트를 호출한다

**Then (결과)**
- 시스템은 HTTP 200 OK 응답을 반환한다
- 응답에 status: "completed"와 resultImageUrl이 포함된다
- resultImageUrl은 유효한 서명된 URL이다
- 썸네일 URL도 함께 제공된다

---

### 시나리오 6: API 실패 및 재시도

**Given (전제 조건)**
- 가상 착용 생성 작업이 큐에 등록되어 있다
- FASHN AI API가 일시적으로 실패 상태이다

**When (실행)**
- 워커가 해당 작업을 처리한다
- FASHN AI API 호출이 실패한다

**Then (결과)**
- 시스템은 지수 백오프로 최대 3회 재시도한다
- 각 재시도 간격: 5초, 10초, 20초
- retryCount가 증가한다
- 3회 실패 후 작업 상태가 "failed"로 변경된다
- 관리자에게 알림이 전송된다
- 에러 메시지가 작업 기록에 저장된다

---

### 시나리오 7: 잘못된 이미지 형식 업로드

**Given (전제 조건)**
- 사용자가 인증된 상태이다
- 업로드할 파일이 지원하지 않는 형식(예: GIF, BMP)이다

**When (실행)**
- 사용자가 POST /api/tryon/upload 엔드포인트에 이미지를 업로드한다

**Then (결과)**
- 시스템은 HTTP 400 Bad Request 응답을 반환한다
- 응답에 error 코드와 지원 형식 목록이 포함된다
- 파일이 스토리지에 저장되지 않는다
- 데이터베이스에 기록이 생성되지 않는다

---

### 시나리오 8: 파일 크기 초과

**Given (전제 조건)**
- 사용자가 인증된 상태이다
- 업로드할 이미지 파일 크기가 10MB를 초과한다

**When (실행)**
- 사용자가 POST /api/tryon/upload 엔드포인트에 이미지를 업로드한다

**Then (결과)**
- 시스템은 HTTP 413 Payload Too Large 응답을 반환한다
- 응답에 최대 허용 파일 크기 정보가 포함된다
- 업로드 프로세스가 조기에 중단된다

---

### 시나리오 9: 모델 이미지 라이브러리 조회

**Given (전제 조건)**
- 사용자가 인증된 상태이다
- 활성화된 모델 이미지가 5개 이상 존재한다

**When (실행)**
- 사용자가 GET /api/tryon/models 엔드포인트를 호출한다

**Then (결과)**
- 시스템은 HTTP 200 OK 응답을 반환한다
- 응답에 활성화된 모델 이미지 목록이 포함된다
- 각 모델에 id, name, imageUrl, category가 포함된다
- 비활성화된 모델은 목록에 포함되지 않는다

---

### 시나리오 10: 결과 이미지 삭제

**Given (전제 조건)**
- 유효한 resultId가 존재한다
- 해당 결과 이미지가 스토리지에 저장되어 있다

**When (실행)**
- 사용자가 DELETE /api/tryon/results/:resultId 엔드포인트를 호출한다

**Then (결과)**
- 시스템은 HTTP 204 No Content 응답을 반환한다
- 스토리지에서 이미지 파일이 삭제된다
- TryOnResult 테이블에서 기록이 삭제된다
- 관련 캐시가 무효화된다

---

## 엣지 케이스 테스트

### EC-001: 동시 요청 처리

**시나리오**: 동일한 상품-모델 조합에 대해 동시에 여러 요청이 들어옴

**예상 동작**:
- 첫 번째 요청만 FASHN AI API를 호출
- 나머지 요청은 첫 번째 작업의 결과를 대기하거나 캐시를 사용
- 중복 API 호출 방지

---

### EC-002: 작업 타임아웃

**시나리오**: 작업 처리 시간이 5분을 초과

**예상 동작**:
- 작업이 자동으로 타임아웃 처리됨
- 상태가 "failed"로 변경됨
- 타임아웃 에러 메시지 기록
- 사용자에게 재시도 옵션 제공

---

### EC-003: Redis 연결 장애

**시나리오**: Redis 서버 연결이 실패

**예상 동작**:
- 시스템이 동기 처리 모드로 전환
- 운영팀에 경고 알림 전송
- 사용자 요청은 지연되지만 처리됨
- 연결 복구 시 자동으로 비동기 모드 복귀

---

### EC-004: 스토리지 업로드 실패

**시나리오**: S3/R2 업로드가 실패

**예상 동작**:
- 최대 3회 재시도
- 실패 시 로컬 임시 저장소에 백업
- 복구 작업이 예약됨
- 에러 로그 기록

---

### EC-005: 낮은 해상도 이미지 입력

**시나리오**: 512x512 미만의 이미지가 업로드됨

**예상 동작**:
- HTTP 400 Bad Request 응답
- 최소 해상도 요구사항 안내
- 이미지가 저장되지 않음

---

### EC-006: 유지보수 모드

**시나리오**: 시스템이 유지보수 모드로 전환됨

**예상 동작**:
- 새로운 생성 요청이 거부됨 (HTTP 503)
- 예상 복구 시간 정보 제공
- 기존 진행 중인 작업은 완료됨
- 상태 조회 API는 정상 작동

---

## 성능 기준

### 응답 시간

| API 엔드포인트 | 목표 응답 시간 | 측정 조건 |
|----------------|----------------|-----------|
| POST /api/tryon/upload | < 2초 | 5MB 이하 이미지 |
| POST /api/tryon/generate | < 500ms | 큐 등록까지 |
| GET /api/tryon/jobs/:jobId | < 100ms | 캐시 미적용 |
| GET /api/tryon/models | < 200ms | 목록 조회 |

### 처리 시간

| 작업 | 목표 시간 | 비고 |
|------|-----------|------|
| 이미지 전처리 | < 3초 | Sharp 리사이징 |
| FASHN AI API 호출 | < 60초 | API 제한 |
| 결과 이미지 저장 | < 2초 | S3/R2 업로드 |
| 전체 생성 프로세스 | < 90초 | 큐 대기 제외 |

### 처리량

| 지표 | 목표 | 측정 기간 |
|------|------|-----------|
| 동시 작업 처리 | 10개 | 동시 |
| 일일 최대 처리량 | 1000건 | 24시간 |
| 큐 대기 시간 | < 30초 | 평균 |

---

## 품질 게이트 (Quality Gates)

### QG-001: 코드 품질

- [ ] ESLint 오류 0개
- [ ] TypeScript 컴파일 오류 0개
- [ ] 단위 테스트 커버리지 80% 이상
- [ ] 코드 리뷰 승인

### QG-002: 기능 완성도

- [ ] 모든 API 엔드포인트 구현 완료
- [ ] Given/When/Then 시나리오 전체 통과
- [ ] 엣지 케이스 테스트 통과
- [ ] 에러 핸들링 검증 완료

### QG-003: 성능

- [ ] 응답 시간 목표 달성
- [ ] 처리 시간 목표 달성
- [ ] 부하 테스트 통과 (동시 10 요청)
- [ ] 메모리 누수 없음

### QG-004: 보안

- [ ] JWT 인증 구현 및 검증
- [ ] 서명된 URL 구현
- [ ] API 키 환경 변수 관리
- [ ] 입력 검증 완료

### QG-005: 운영 준비

- [ ] 로깅 구현 완료
- [ ] 모니터링 대시보드 설정
- [ ] 알림 구성 완료
- [ ] 운영 문서 작성

---

## 테스트 유형별 요구사항

### 단위 테스트

| 모듈 | 필수 테스트 항목 |
|------|------------------|
| FASHN Client | API 호출, 에러 핸들링, 재시도 로직 |
| Image Processor | 형식 변환, 리사이징, 검증 |
| Queue Manager | 작업 등록, 상태 업데이트, 재시도 |
| Cache Layer | 캐시 저장, 조회, 무효화, TTL |
| Storage Service | 업로드, 다운로드, 삭제, 서명 URL |

### 통합 테스트

| 플로우 | 설명 |
|--------|------|
| 업로드-저장 플로우 | 이미지 업로드 → 전처리 → 스토리지 저장 → DB 기록 |
| 생성 요청 플로우 | 요청 → 검증 → 큐 등록 → 응답 |
| 작업 처리 플로우 | 큐 처리 → API 호출 → 결과 저장 → 상태 업데이트 |
| 캐시 플로우 | 요청 → 캐시 확인 → 캐시 히트/미스 처리 |

### E2E 테스트

| 시나리오 | 설명 |
|----------|------|
| 전체 가상 착용 플로우 | 이미지 업로드 → 모델 선택 → 생성 → 결과 확인 |
| 에러 복구 플로우 | API 실패 → 재시도 → 성공/최종 실패 |
| 캐시 활용 플로우 | 첫 요청 → 결과 저장 → 재요청 → 캐시 반환 |

---

## 검증 체크리스트

### 기능 검증

- [ ] 상품 이미지 업로드 정상 동작
- [ ] 모델 이미지 관리 정상 동작
- [ ] 가상 착용 생성 요청 정상 동작
- [ ] 작업 상태 조회 정상 동작
- [ ] 결과 이미지 조회 정상 동작
- [ ] 캐싱 정상 동작
- [ ] 에러 핸들링 정상 동작

### 비기능 검증

- [ ] 성능 목표 달성
- [ ] 보안 요구사항 충족
- [ ] 확장성 검증
- [ ] 모니터링 구현

---

## Definition of Done (완료 정의)

SPEC-TRYON-001은 다음 조건을 모두 만족할 때 완료로 간주합니다:

1. **기능 완성**: 모든 EARS 요구사항이 구현됨
2. **테스트 통과**: 모든 Given/When/Then 시나리오가 통과함
3. **품질 게이트 통과**: 모든 품질 게이트 항목이 승인됨
4. **문서화 완료**: API 문서, 운영 가이드가 작성됨
5. **코드 리뷰 완료**: 최소 1명의 리뷰어 승인
6. **배포 준비 완료**: 스테이징 환경에서 검증됨

---

**Document Version**: 1.0.0
**Last Updated**: 2025-12-23
**Status**: Draft
**Traceability**: spec.md, plan.md
